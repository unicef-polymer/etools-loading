<link rel="import" href="etools-loading.html">
<script>
  window.etoolsBehaviors = window.etoolsBehaviors || {};

  /** @polymerBehavior etoolsBehaviors.LoadingBehavior */
  etoolsBehaviors.LoadingBehavior = { // eslint-disable-line no-undef
    listeners: {
      'global-loading': 'handleLoading',
    },
    ready: function() {
      // create loading element, used for global loading
      this.globalLoadingElement = this.createLoading();
      this.globalLoadingElement.messages = [];
    },

    /**
     * This method will create an etools-loading absolute element
     * (loading element is appended to the body and it will cover entire screen)
     * @param loadingMessage
     * @returns {Element}
     */
    createLoading: function(loadingMessage) {
      var newLoadingElement = document.createElement('etools-loading');
      if (typeof loadingMessage === 'string' && loadingMessage !== '') {
        newLoadingElement.loadingText = loadingMessage;
      }
      newLoadingElement.absolute = true;
      Polymer.dom(document.querySelector('body')).appendChild(newLoadingElement);
      return newLoadingElement;
    },

    /**
     * Use this method to remove a loading element in the detached state of the element where loading is used
     * @param loadingElement
     */
    removeLoading: function(loadingElement) {
      if (loadingElement) {
        Polymer.dom(document.querySelector('body')).removeChild(loadingElement);
      }
    },

    addMessageToQue: function(messages, source) {
      var _messages = _.slice(messages);
      _messages.push(source);
      return _messages;
    },

    removeMessageFromQue: function(messages, source) {
      var _messages = _.slice(messages);
      _.remove(_messages, {loadingSource: source.loadingSource});
      return _messages;
    },

    /**
     * Show loading when data is requested from server, or save is in progress...
     */
    handleLoading: function (event) {
      event.stopImmediatePropagation();
      if (this.globalLoadingElement) {
        var loadingSource = _.get(event, 'path.0.localName','na');
        if (event.detail.active) {
          var message = _.get(event, 'detail.message', 'Loading...');
          this.globalLoadingElement.messages = this.addMessageToQue(this.globalLoadingElement.messages,{
            loadingSource: loadingSource,
            message: message
          });
          this.globalLoadingElement.loadingText = _.last(this.globalLoadingElement.messages).message;
          this.globalLoadingElement.active = true;
        } else {
          this.globalLoadingElement.messages = this.removeMessageFromQue(this.globalLoadingElement.messages, {
            loadingSource: loadingSource
          });
          if (_.isEmpty(this.globalLoadingElement.messages)){
            this.globalLoadingElement.active = false;
          }else {
            this.globalLoadingElement.loadingText = _.last(this.globalLoadingElement.messages).message;
          }
        }

      }
    }


  };
</script>
